<!DOCTYPE html>
<html lang="en">
  <head>
    <title>buttons-are-cool server demo</title>
    <meta charset="utf-8"></meta>
    <script type="text/javascript" src="minivents.min.js"></script>
    <script type="text/javascript" src="dat.gui.min.js"></script>
    <script type="text/javascript">
      // Build a hierarchy of DOM nodes for faster manipulation.
      var deviceContainers = [];
      var activeDeviceNums = [];

      function ready(fn) {
        if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading"){
          fn();
        } else {
          document.addEventListener('DOMContentLoaded', fn);
        }
      }

      ready(function() {
        createButtons();
        guiController.startWebSocket();

        // Set up dat.gui for switching connection types and params at runtime.
        var gui = new dat.GUI();
        gui.add(guiController, 'mode').listen();
        gui.add(guiController.listener, 'state').listen();
        gui.add(guiController, 'stopAll');
        gui.add(guiController, 'startWebSocket');
        gui.add(guiController, 'startHTTPPolling');
        gui.add(httpListener, 'interval').min(100).max(5000);
        setInterval(() => console.log(guiController.listener.state), 1000);
      });

      var guiController = {
        mode: 'WebSocket Events',
        listener: null,
        startWebSocket: function() {
          if (this.listener) this.listener.stop();
          this.mode = 'WebSocket Events';
          this.listener = websocketListener;
          this.listener.start();
        },
        startHTTPPolling: function() {
          if (this.listener) this.listener.stop();
          this.mode = 'HTTP Polling';
          this.listener = httpListener;
          this.listener.start();
        },
        stopAll: function() {
          httpListener.stop();
          websocketListener.stop();
        }
      };

      // Create a bunch of HTML for device names and button statuses.
      function createButtons() {
        var container = document.querySelector('.container');
        container.innerHTML = '';
        for (var deviceNum = 0; deviceNum < 6; deviceNum++) {
          deviceContainers[deviceNum] = { buttons: {} };

          var title = document.createElement('h2');
          title.classList.add('device-title');
          title.classList.add('hidden');
          container.appendChild(title);
          deviceContainers[deviceNum].title = title;

          var deviceDiv = document.createElement('div');
          deviceDiv.classList.add('device');
          deviceDiv.classList.add('hidden');
          container.appendChild(deviceDiv);
          deviceContainers[deviceNum].buttonContainer = deviceDiv;

          for (var buttonNum = 0; buttonNum < 60; buttonNum++) {
            var div = document.createElement('div');
            div.classList.add('hidden');
            div.innerHTML = '<span class="number-column">' + buttonNum + ':</span> <span class="icon"></span>';
            deviceDiv.appendChild(div);
            deviceContainers[deviceNum].buttons[buttonNum] = div;
          }
        }
      }

      // ***********************************************************************
      // Example HTTP polling event emitter. Emits 'testMode', 'buttonUp', and
      // 'buttonDown' events after diffing device snapshots between requests.
      // ***********************************************************************
      var httpListener = {
        interval: 300,
        state: 'disconnected',
        loop: null,
        testmode: false,
        lastDevices: [],
        start: function() {
          this.run();
        },
        run: function() {
          var self = this;
          // Call the API.
          fetch('/buttons')
            .then(function(res) {
              self.state = 'connected';
              return res.json();
            })
            .then(function(json) {
              if (json.testmode !== self.testmode) {
                self.emit('testmode', {isTestMode: json.testmode});
              }
              // Devices changed? Initial poll? Refresh everything.
              if (json.devices.length !== self.lastDevices.length) {
                self.lastDevices = json.devices;
                // Emit events for all buttons.
                json.devices.forEach(function(device, deviceIdx) {
                  Object.keys(device.buttons).forEach(function(buttonNum) {
                    var eventName = device.buttons[buttonNum] ? 'buttonDown' : 'buttonUp';
                    self.emit(eventName, {deviceNum: deviceIdx, buttonNum: buttonNum, deviceName: device.name});
                  });
                });
              } else {
                json.devices.forEach(function(newDevice, deviceIdx) {
                  var oldDevice = self.lastDevices[deviceIdx];
                  // Emit events only for buttons changed since last update.
                  Object.keys(newDevice.buttons).forEach(function(buttonNum) {
                    if (newDevice.buttons[buttonNum] !== oldDevice.buttons[buttonNum]) {
                      var eventName = newDevice.buttons[buttonNum] ? 'buttonDown' : 'buttonUp';
                      self.emit(eventName, {deviceNum: deviceIdx, buttonNum: buttonNum, deviceName: newDevice.name});
                    }
                  })
                });
                self.lastDevices = json.devices;
              }
              // Poll again at an interval.
              self.loop = setTimeout(self.run.bind(self), self.interval);
            })
            .catch(() => self.state = 'disconnected');
        },
        stop: function() {
          clearInterval(this.loop);
          this.state = 'stopped';
        }
      };
      Events(httpListener);
      // Wire up events.
      httpListener.on('testMode', setTestMode);
      httpListener.on('buttonUp', setButtonUp);
      httpListener.on('buttonDown', setButtonDown);

      // ***********************************************************************
      // Example WebSocket event emitter. Emits 'testMode', 'buttonUp', and
      // 'buttonDown' events as they come in from the server.
      // ***********************************************************************
      var websocketListener = {
        socket: null,
        state: 'disconnected',
        start: function() {
          var isReconnecting = false;
          var url = new URL(window.location);
          var protocol = url.protocol === 'https:' ? 'wss://' : 'ws://';
          var host = url.host;
          var path = url.pathname;

          this.socket = new WebSocket(protocol + host + '/' + path);

          this.socket.onopen = function() {
            console.log('WebSocket connected!');
            this.state = 'connected';
          }.bind(this);
          this.socket.onmessage = function(msg) {
            var packet = JSON.parse(msg.data);
            this.emit(packet.name, packet);
          }.bind(this);
          this.socket.onerror = this.socket.onclose = function(err) {
            if (!isReconnecting) {
              this.state = 'disconnected';
              isReconnecting = true;
              this.start();
            }
          }.bind(this);
        },
        stop: function() {
          if (!this.socket) return;
          this.socket.onclose = null;
          this.socket.close();
          this.state = 'stopped';
        }
      };
      Events(websocketListener);
      // Wire up events.
      websocketListener.on('testMode', setTestMode);
      websocketListener.on('buttonUp', setButtonUp);
      websocketListener.on('buttonDown', setButtonDown);

      // On testMode events, set the test-mode class on the body element to pick
      // up appropriate page style and mode message.
      function setTestMode(packet) {
        var body = document.querySelector('body');
        if (packet.isTestMode && !body.classList.contains('test-mode')) {
          body.classList.add('test-mode');
        } else if (!packet.isTestMode) {
          body.classList.remove('test-mode');
        }
      }

      function showDevice(deviceNum, deviceName) {
        if (!activeDeviceNums[deviceNum]) {
          activeDeviceNums[deviceNum] = true;
          deviceContainers[deviceNum].title.classList.remove('hidden');
          deviceContainers[deviceNum].title.innerHTML = deviceName;
          deviceContainers[deviceNum].buttonContainer.classList.remove('hidden');
        }
      }

      // On buttonUp events, show device title, show device button container,
      // show button status, and remove button "pressed" state.
      function setButtonUp(packet) {
        showDevice(packet.deviceNum, packet.deviceName);
        deviceContainers[packet.deviceNum].buttons[packet.buttonNum].classList.remove('hidden');
        deviceContainers[packet.deviceNum].buttons[packet.buttonNum].classList.remove('pressed');
      }

      // On buttonDown events, show device title, show device button container,
      // show button status, and mark button "pressed".
      function setButtonDown(packet) {
        showDevice(packet.deviceNum, packet.deviceName);
        deviceContainers[packet.deviceNum].buttons[packet.buttonNum].classList.remove('hidden');
        deviceContainers[packet.deviceNum].buttons[packet.buttonNum].classList.add('pressed');
      }
    </script>

    <style type="text/css">
      @import url('https://fonts.googleapis.com/css?family=Francois+One');

      * {
        box-sizing: border-box;
      }

      /* Reset */
      html, body, h1, h2, h3, h4, h5, h6, p, ol, ul, li, dl, dt, dd, blockquote, address {
        margin: 0;
        padding: 0;
      }

      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        flex-wrap: nowrap;
        padding-top: 20px;
        font-family: "Francois One",Tahoma,Verdana,Sans;
        background-color: #EFFFD9;
        color: #806970;
      }

      a {
        color: #E6AABB;
      }

      a:visited {
        color: #B099A0;
      }

      .test-mode-note {
        display: none;
      }

      .live-mode-note {
        display: block;
      }

      body.test-mode {
        background-color: #FFE6C2;
      }

      body.test-mode .test-mode-note {
        display: block;
      }

      body.test-mode .live-mode-note {
        display: none;
      }

      body h2 {
        clear: both;
      }

      .container {
        display: flex;
        flex-direction: column;
        flex-wrap: nowrap;
        min-width: 460px;
        max-width: 600px;
        width: 50%;
        margin: 0;
        margin-top: 10px;
        margin-bottom: 10px;
        padding: 15px;
        border: 5px solid #FFC7C2;
        border-radius: 15px;
      }

      .device {
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        width: 100%;
        max-height: 300px;
      }

      .device h2 {
        display: block;
      }

      .device > div {
        width: 20%;
      }

      .number-column {
        display: block;
        float: left;
        min-width: 3rem;
      }

      .center {
        text-align: center;
      }

      .full-width {
        width: 100%;
      }

      .hidden {
        display: none;
      }

      .no-decorate {
        text-decoration: none;
      }

      .device span.icon::after {
        color: red;
        content: '⭕';
      }

      .device .pressed span.icon::after {
        color: green;
        content: '✅';
      }
    </style>
  </head>
  <body>
    <div class="center full-width">
      <h2><a class="no-decorate" href="http://buttonsare.cool">1000 Button Project</a> Test Page</h2>
      <div class='test-mode-note'>(Test Mode)</div>
      <div class='live-mode-note'>(Live Mode)</div>
    </div>
    <div class="container"></div>
    <div><a href="https://github.com/mildmojo/buttons-are-cool-node">Get the source</a> on GitHub.</div>
  </body>
</html>
